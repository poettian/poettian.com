<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="LNMP架构中的buffer机制"/>




  <meta name="keywords" content="php, 健忘的记事本" />










  <link rel="alternate" href="/default" title="健忘的记事本">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1" />



<link rel="canonical" href="https://www.poettian.com/2018/11/05/LNMP架构中的缓冲区/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1" />



  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a366524a3aa0beb76dced93bc66a1e21";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "OfHn2rURzWXvGqhoYEBtqC4J-gzGzoHsz",
      appKey: "wLjSd10AO01D1Bwbutam1snw"
    });
  </script>




<script>
  window.config = {"title":"健忘的记事本","subtitle":null,"description":"好记性不如烂笔头","author":"poettian","language":"zh-CN","timezone":null,"url":"https://www.poettian.com","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":true,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null,"first_line_number":"always1"},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":"even","deploy":[{"type":"git","repo":"https://github.com/poettian/poettian.com.git","branch":"master"},{"type":"leancloud_counter_security_sync"}],"ignore":[],"index_generator":{"per_page":10,"order_by":"-date","path":""},"leancloud_counter_security":{"enable_sync":true,"app_id":"OfHn2rURzWXvGqhoYEBtqC4J-gzGzoHsz","app_key":"wLjSd10AO01D1Bwbutam1snw","username":"poettian","password":"Gg450972998"},"algolia":{"applicationID":"8UR669C6NW","apiKey":"983f3b72ca627207def729571824f32d","adminApiKey":"5f3e1f0e45b13ddb06586cc6753ab04b","indexName":"hexo_search","chunkSize":5000},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":10},"tag_generator":{"per_page":10},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true},"since":2017,"favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags","Categories":"/categories","About":"/about"},"color":"cobalt blue","mode":"default","toc":true,"fancybox":true,"pjax":true,"copyright":{"enable":true,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>"},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"poettian@gmail.com","stack-overflow":null,"twitter":"https://twitter.com/poettian_tian","facebook":null,"linkedin":null,"google":null,"github":"https://github.com/poettian","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":"OfHn2rURzWXvGqhoYEBtqC4J-gzGzoHsz","app_key":"wLjSd10AO01D1Bwbutam1snw"},"baidu_analytics":"a366524a3aa0beb76dced93bc66a1e21","baidu_verification":null,"google_analytics":null,"google_verification":null,"disqus_shortname":"poettian","changyan":{"appid":null,"appkey":null},"livere_datauid":null,"version":"2.10.1"};
</script>

    <title> LNMP架构中的buffer机制 - 健忘的记事本 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">健忘的记事本</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">健忘的记事本</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          LNMP架构中的buffer机制
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-11-05
        </span>
        
          <span class="post-category">
            
              <a href="/categories/技术/">技术</a>
            
          </span>
        
        
        <span class="post-visits"
             data-url="/2018/11/05/LNMP架构中的缓冲区/"
             data-title="LNMP架构中的buffer机制">
          阅读次数 0
        </span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是缓冲区-buffer"><span class="toc-text">什么是缓冲区(buffer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么需要缓冲区"><span class="toc-text">为什么需要缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LNMP架构下的多层缓冲区"><span class="toc-text">LNMP架构下的多层缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php的缓冲区"><span class="toc-text">php的缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SAPI的缓冲区"><span class="toc-text">SAPI的缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx的缓冲区"><span class="toc-text">Nginx的缓冲区</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <h3 id="什么是缓冲区-buffer"><a href="#什么是缓冲区-buffer" class="headerlink" title="什么是缓冲区(buffer)"></a>什么是缓冲区(buffer)</h3><p>当执行 PHP 脚本中输出指令时，例如：<code>header()</code> <code>setcookie()</code>  <code>session_start()</code> 以及我们常用的<code>echo</code> <code>print</code> 等，此时产生的数据会有两种行为模式选择，一是立即发送到下游SAPI；二是缓存起来等积累到一定的大小后再发送到下游SAPI，这种先将输出数据存起来等之后再发送的机制，就是缓冲区。</p>
<h3 id="为什么需要缓冲区"><a href="#为什么需要缓冲区" class="headerlink" title="为什么需要缓冲区"></a>为什么需要缓冲区</h3><ol>
<li>没有缓冲区，数据立即发送给SAPI，这会使得数据以碎片形式不断传输，降低php和SAPI间通讯的效率；</li>
<li>没有缓冲区，你将无法对输出数据在发送前做一些操作，而缓冲区的存在使得你可以任意加工这些数据，然后选择你认为合适的时机再发送；</li>
<li>如果你遇到过这样的提示 “Warning: Cannot modify header information - headers already sent by (output)”，那么你可以利用缓冲区来解决。</li>
</ol>
<h3 id="LNMP架构下的多层缓冲区"><a href="#LNMP架构下的多层缓冲区" class="headerlink" title="LNMP架构下的多层缓冲区"></a>LNMP架构下的多层缓冲区</h3><p>上面我们谈到的缓冲区只是指 php 脚本运行时存在于php进程内存中（到底存在于哪里我并不清楚，这只是我的理解）的缓冲区，只讨论这一个缓冲区是不够的。</p>
<p>在LNMP架构下，每一层都存在着缓冲区：</p>
<ol>
<li>php的缓冲区</li>
<li>SAPI（php-fpm）的缓冲区</li>
<li>webserver（nginx）的缓冲区</li>
</ol>
<p>用一张图可以很好的说明这几者间的关系：</p>
<img src="/2018/11/05/LNMP架构中的缓冲区/图1.png" title="PHP buffer flow">
<h3 id="php的缓冲区"><a href="#php的缓冲区" class="headerlink" title="php的缓冲区"></a>php的缓冲区</h3><p>php默认开启了缓冲区，大小为4096字节，这可以在配置文件 php.ini 中看到，参数项 <code>output_buffering = 4096</code> 即指明了缓冲区开启并设置大小为4096字节。</p>
<p>其他参数值如下：</p>
<blockquote>
<p>On = Enabled and buffer is unlimited. (Use with caution)<br>Off = Disabled<br>Integer = Enables the buffer and sets its maximum size in bytes.</p>
</blockquote>
<p>当输出数据没有超过此值时，php将不断接收并缓存这些数据，而一旦超出该值，那么php就会刷新缓冲区将数据送往SAPI。这是php中默认缓冲区的行为机制。</p>
<p>php为开发者提供了自定义缓冲区的能力，借助 <code>ob_start</code> 函数，开发者可以定义新的缓冲区并可以嵌套（多次调用 <code>ob_start</code>），这些缓冲区将被压入栈中。当数据过来时， 会存入栈顶的缓冲区中，当数据大小超出缓冲区定义的 size 或 调用 <code>ob_flush</code> 和 <code>ob_end_flush</code> 时则将数据送到下一个缓冲区中，如此直到 php 默认的缓冲区（存在于栈底），最后送入SAPI。</p>
<h3 id="SAPI的缓冲区"><a href="#SAPI的缓冲区" class="headerlink" title="SAPI的缓冲区"></a>SAPI的缓冲区</h3><p>SAPI有cli、mod_php、php-fpm等多种形式，不同的SAPI，缓冲区的存在和表现形式也大不相同。</p>
<p>在讲这几个SAPI的区别前，先来看 php.ini 中的一个配置项 <code>implicit_flush</code> 和 函数 <code>ob_implicit_flush()</code> 。</p>
<blockquote>
<p><em>implicit_flush</em>的作用，<a href="http://lxr.php.net/xref/PHP_5_5/main/output.c#1095" target="_blank" rel="noopener">源代码已说明一切</a>：当<em>implicit_flush</em>被设置为打开（值为1），一旦有任何输出写入到SAPI缓冲区层，它都会立即刷新（flush，意思是把这些数据写入到更低层，并且缓冲区会被清空），将数据送往下一层。</p>
</blockquote>
<blockquote>
<p>ob_implicit_flush 的作用和 implicit_flush 类似，当调用 ob_implicit_flush(true) 时表示打开绝对（隐式）刷送，和 设置 implicit_flush=1 作用相同；当调用 ob_implicit_flush(false) 则表示关闭绝对（隐式）刷送，和 设置 implicit_flush=0 作用相同。</p>
</blockquote>
<p>下面说一下这几个SAPI的区别：</p>
<p>cli 会将 ini 配置中的 <em>output_buffer</em> 选项强制设置为0，这表示禁用默认PHP输出缓冲区。所以在CLI中，默认情况下你要输出的东西会直接传递到SAPI层，除非你手动调用ob_()类函数。并且在CLI中，<em>implicit_flush</em> 的值也会被设置为1。</p>
<p>mod_php 不会缓存数据，将直接把数据送往 Apache。</p>
<p>php-fpm 中有一个硬编码的8k大小的缓冲区。使用 <code>flush()</code> 函数会刷新这个缓冲区，把数据送往webserver。</p>
<h3 id="Nginx的缓冲区"><a href="#Nginx的缓冲区" class="headerlink" title="Nginx的缓冲区"></a>Nginx的缓冲区</h3><p>nginx的缓冲区机制主要由下面几个参数来控制：</p>
<p><strong>fastcgi_buffering</strong> on | off;</p>
<p>开启或关闭接收来自 FastCGI server 的响应的缓冲区。</p>
<p>当缓冲区被打开，nginx将立即接收来自 FastCGI server 的响应并把响应头和响应体分别存入由 <code>fastcgi_buffer_size</code> <code>fastcgi_buffers</code> 控制的缓冲区内。如果响应体积太大，部分响应内容将被写入临时文件中，临时文件的路径和大小以及每次写入临时文件的数据体大小分别由 <code>fastcgi_temp_path</code> <code>fastcgi_max_temp_file_size</code> <code>fastcgi_temp_file_write_size</code> 这三个配置项来决定。</p>
<p>如果缓冲区被关闭，那么nginx会把从 FastCGI server 接收到的响应数据立即发送给客户端。</p>
<p>使用 <code>X-Accel-Buffering</code> 这个响应头也可以控制缓冲区的打开和关闭，<code>header(&#39;X-Accel-Buffering: no&#39;)</code> 关闭，<code>header(&#39;X-Accel-Buffering: yes&#39;);</code> 打开。</p>
<p><strong>fastcgi_buffer_size</strong> size;</p>
<p>设置接收 FastCGI server 第一部分响应（通常包含体积很小的响应头）的缓冲区的大小。默认大小等于一个内存页，或者4k或者8k，和操作系统有关。</p>
<p><strong>fastcgi_buffers</strong> number size;</p>
<p>设置单个连接中接收 FastCGI server 响应体的缓冲区的数量和每个缓冲区的大小。默认每个缓冲区大小等于一个内存页，或者4k或者8k，和操作系统有关。</p>
<p><strong>fastcgi_busy_buffers_size</strong> size;</p>
<p>没看明白的一个配置项，手册上的解释为：</p>
<blockquote>
<p>When <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_buffering" target="_blank" rel="noopener">buffering</a> of responses from the FastCGI server is enabled, limits the total <code>*size*</code> of buffers that can be busy sending a response to the client while the response is not yet fully read. In the meantime, the rest of the buffers can be used for reading the response and, if needed, buffering part of the response to a temporary file. By default, <code>*size*</code> is limited by the size of two buffers set by the <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_buffer_size" target="_blank" rel="noopener">fastcgi_buffer_size</a>and <a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_buffers" target="_blank" rel="noopener">fastcgi_buffers</a> directives.</p>
</blockquote>
<p>但实际上nginx并不会等数据塞满 buffer 后才发送给client，具体机制还不明确，待研究。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://www.poettian.com">poettian</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://www.poettian.com/2018/11/05/LNMP架构中的缓冲区/">https://www.poettian.com/2018/11/05/LNMP架构中的缓冲区/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/php/">php</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2018/10/18/博客迁移说明/">
        <span class="next-text nav-default">博客迁移说明</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:poettian@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/poettian_tian" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/poettian" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">poettian</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://www.poettian.com/2018/11/05/LNMP架构中的缓冲区/';
        this.page.identifier = '2018/11/05/LNMP架构中的缓冲区/';
        this.page.title = 'LNMP架构中的buffer机制';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//poettian.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
